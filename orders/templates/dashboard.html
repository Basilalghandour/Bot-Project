{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confirm It - Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- Global Styles & Variables --- */
        :root {
            --bg-dark: #121212;
            --card-bg: #1e1e1e;
            --border-color: #3a3a3a;
            --primary-green: #2ecc71;
            --text-white: #e0e0e0;
            --text-grey: #a0a0a0;
            --text-dark-grey: #6b6b6b;
            --status-pending: #f39c12;
            --status-cancelled: #e74c3c;
            --font-family: 'Inter', sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-dark);
            color: var(--text-white);
            font-size: 15px;
            line-height: 1.5;
            zoom: 0.9;
        }

        main { padding-top: 40px; }
        .container { max-width: 1600px; margin: 0 auto; padding: 0 30px; }
        h2, h3 { font-weight: 600; }

        .applogo { object-fit: cover; height: 100px; width: 220px; opacity: 0; animation: fadeIn 0.5s ease-out forwards; }

        .stats-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 40px; }

        .stat-card { background-color: var(--card-bg); border-radius: 8px; padding: 20px; border: 1px solid var(--border-color); position: relative; opacity: 0; animation: fadeIn 0.5s ease-out forwards; }
        .stat-card:nth-child(1) { animation-delay: 0.2s; }
        .stat-card:nth-child(2) { animation-delay: 0.4s; }
        .stat-card:nth-child(3) { animation-delay: 0.6s; }
        .stat-card:nth-child(4) { animation-delay: 0.8s; }
        .stat-card:hover { background-color: #252525; border-color: #4a4a4a; }

        .card-icon { position: absolute; top: 20px; right: 20px; width: 30px; height: 30px; display:flex; align-items:center; justify-content:center; border-radius:50%; color: var(--text-white); }
        .card-icon.total-icon { font-size:1.5rem; background-color:#555; }
        .card-icon.confirmed-icon { background-color: var(--primary-green); padding:6px; }
        .card-icon.pending-icon { background-color: var(--status-pending); padding:6px; }
        .card-icon.cancelled-icon { background-color: var(--status-cancelled); padding:6px; }

        .card-content h3 { color: var(--text-grey); font-size: 0.9rem; font-weight: 500; margin-bottom: 8px; text-transform:uppercase; letter-spacing:0.5px; }
        .card-content p { font-size: 1.8rem; font-weight: 600; color: var(--text-white); }

        .orders-section { background-color: var(--card-bg); padding: 25px; border-radius: 8px; border: 1px solid var(--border-color); opacity:0; animation: fadeIn 0.5s ease-out forwards; animation-delay:1.0s; }

        .orders-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:15px; }
        .orders-header h2 { font-size: 1.2rem; }

        .filter-controls { display:flex; gap:12px; }

        .custom-select-wrapper { position: relative; width: 180px; font-family: var(--font-family); }
        .select-selected { background-color: #2a2a2a; color: var(--text-white); padding: 8px 12px; border:1px solid var(--border-color); border-radius:6px; cursor:pointer; display:flex; justify-content:space-between; align-items:center; }
        .custom-select-wrapper.active .select-selected { border-color: var(--primary-green); }
        .select-selected::after { content: ""; width:0;height:0;border-left:5px solid transparent;border-right:5px solid transparent;border-top:5px solid var(--text-grey); transition:transform .2s; }
        .custom-select-wrapper.active .select-selected::after { transform: rotate(180deg); }

        .select-items { position:absolute; background-color:#2a2a2a; top: calc(100% + 5px); left:0; right:0; z-index:99; border:1px solid var(--border-color); border-radius:6px; overflow:hidden; opacity:0; transform:translateY(-10px); pointer-events:none; transition:opacity .2s, transform .2s; }
        .custom-select-wrapper.active .select-items { opacity:1; transform:translateY(0); pointer-events:auto; }
        .select-items div { color: var(--text-white); padding:8px 12px; cursor:pointer; font-size:0.9rem; }
        .select-items div:hover { background-color: var(--primary-green); color:#fff; }

        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { padding: 12px 15px; text-align:left; border-bottom:1px solid var(--border-color); }
        thead th { font-size:0.8rem; font-weight:600; color:var(--text-grey); text-transform:uppercase; letter-spacing:0.5px; border-bottom-width:2px; }
        tbody tr { transition: background-color 0.2s; }
        tbody tr:nth-child(even) { background-color: #222222; }
        tbody tr:hover { background-color: #2c2c2c; }
        td { font-size:0.95rem; }

        .status { padding: 4px 10px; border-radius:12px; font-size:0.75rem; font-weight:600; display:inline-flex; align-items:center; gap:5px; }
        .status .icon-svg { height:1.1em; width:1.1em; }
        .status.confirmed { background-color: rgba(46,204,113,0.15); color: #2ecc71; }
        .status.pending { background-color: rgba(243,156,18,0.15); color: #f39c12; }
        .status.cancelled { background-color: rgba(231,76,60,0.15); color: #e74c3c; }

        @media (max-width: 768px) {
            body { font-size: 14px; zoom:1; }
            main { padding-top: 30px; }
            .container { padding: 0 15px; }
            .applogo { width:150px; margin-bottom:30px; }
            .orders-header { flex-direction:column; align-items:flex-start; }
            .filter-controls { flex-direction:column; width:100%; }
            .custom-select-wrapper { width:100%; }
            th, td { padding:10px; }
        }
    </style>
</head>
<body>
       
    <main class="container">
        
        <img src="{% static 'orders/applogo.png' %}" alt="Confirm It Logo" class="applogo">

        <section class="stats-section">
            <div class="stat-card">
                <div class="card-icon total-icon">ðŸ“¦</div>
                <div class="card-content">
                    <h3>Total Orders</h3>
                    <p>{{ metrics.total_orders|default:"0" }}</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="card-icon confirmed-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path fill="white" d="M9 16.17L4.83 12L3.41 13.41L9 19L21 7L19.59 5.59L9 16.17Z"/>
                    </svg>
                </div>
                <div class="card-content">
                    <h3>Confirmed Orders</h3>
                    <p>{{ metrics.confirmed|default:"0" }}</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="card-icon pending-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path fill="white" d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm0 18 c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z"/>
                        <path fill="white" d="M13 7h-2v6l5.25 3.15.75-1.23-4-2.42V7z"/>
                    </svg>
                </div>
                <div class="card-content">
                    <h3>Pending Orders</h3>
                    <p>{{ metrics.pending|default:"0" }}</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="card-icon cancelled-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path fill="white" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                    </svg>
                </div>
                <div class="card-content">
                    <h3>Cancelled</h3>
                    <p>{{ metrics.cancelled|default:"0" }}</p>
                </div>
            </div>
        </section>

        <section class="orders-section">
            <div class="orders-header">
                <h2>Recent Orders</h2>
                <div class="filter-controls">
                    <div class="custom-select-wrapper" id="status-filter">
                        <div class="select-selected">All Statuses</div>
                        <div class="select-items">
                            <div data-value="all">All Statuses</div>
                            <div data-value="confirmed">Confirmed</div>
                            <div data-value="pending">Pending</div>
                            <div data-value="cancelled">Cancelled</div>
                        </div>
                    </div>

                    <div class="custom-select-wrapper" id="time-filter">
                        <div class="select-selected">All Time</div>
                        <div class="select-items">
                            <div data-value="all-time">All Time</div>
                            <div data-value="today">Today</div>
                            <div data-value="last-week">Last Week</div>
                            <div data-value="last-month">Last Month</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Customer Name</th>
                            <th>Phone</th>
                            <th>Governorate</th>
                            <th>Order Id</th>
                            <th>Price</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="orders-tbody">
                        {# Loop orders passed from view #}
                        {% for o in orders %}
                        <tr data-status="{{ o.status|lower }}" data-created="{{ o.created_at|date:'U' }}">
                            <td>
                              {% if o.customer %}
                                {{ o.customer.first_name }} {{ o.customer.last_name }}
                              {% else %}
                                -
                              {% endif %}
                            </td>
                            <td>{% if o.customer %}{{ o.customer.phone }}{% else %}-{% endif %}</td>
                            <td>{% if o.customer %}{{ o.customer.state }}{% else %}-{% endif %}</td>
                            <td>{{ o.external_id|default:o.id }}</td>
                            <td>${{ o.total_price|floatformat:2 }}</td>
                            <td>
                                <span class="status {% if o.status|lower == 'confirmed' %}confirmed{% elif o.status|lower == 'pending' %}pending{% else %}cancelled{% endif %}">
                                    {% if o.status|lower == 'confirmed' %}
                                        <svg class="icon-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="currentColor" d="M9 16.17L4.83 12L3.41 13.41L9 19L21 7L19.59 5.59L9 16.17Z"/></svg>
                                    {% elif o.status|lower == 'pending' %}
                                        <svg class="icon-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                            <path fill="currentColor" d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z"/>
                                            <path fill="currentColor" d="M13 7h-2v6l5.25 3.15.75-1.23-4-2.42V7z"/>
                                        </svg>
                                    {% else %}
                                        <svg class="icon-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="currentColor" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                                    {% endif %}
                                    {{ o.status|capfirst }}
                                </span>
                            </td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="6">No orders yet.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </section>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Custom Select Dropdown Logic (unchanged) ---
            document.querySelectorAll('.custom-select-wrapper').forEach(wrapper => {
                const selected = wrapper.querySelector('.select-selected');
                const optionsContainer = wrapper.querySelector('.select-items');
                const optionsList = optionsContainer.querySelectorAll('div');

                selected.addEventListener('click', (e) => {
                    e.stopPropagation();
                    document.querySelectorAll('.custom-select-wrapper').forEach(otherWrapper => {
                        if (otherWrapper !== wrapper) otherWrapper.classList.remove('active');
                    });
                    wrapper.classList.toggle('active');
                });

                optionsList.forEach(option => {
                    option.addEventListener('click', () => {
                        selected.textContent = option.textContent;
                        wrapper.classList.remove('active');

                        // determine which filter changed
                        if (wrapper.id === 'status-filter') {
                            applyFilters();
                        } else if (wrapper.id === 'time-filter') {
                            applyFilters();
                        }
                    });
                });
            });

            window.addEventListener('click', () => {
                document.querySelectorAll('.custom-select-wrapper').forEach(wrapper => wrapper.classList.remove('active'));
            });

            // --- Simple client-side filtering by status + timeframe ---
            function applyFilters() {
                const statusVal = document.querySelector('#status-filter .select-selected').textContent.trim().toLowerCase();
                const timeVal = document.querySelector('#time-filter .select-selected').textContent.trim().toLowerCase();

                const rows = document.querySelectorAll('#orders-tbody tr[data-status]');
                const now = Date.now();

                rows.forEach(row => {
                    const rowStatus = row.getAttribute('data-status') || '';
                    const createdTs = parseInt(row.getAttribute('data-created') || '0', 10) * 1000; // data-created is seconds
                    let visible = true;

                    // status filter
                    if (statusVal !== 'all statuses' && statusVal !== 'all') {
                        if (!rowStatus.includes(statusVal)) visible = false;
                    }

                    // time filter
                    if (timeVal !== 'all time' && timeVal !== 'all-time' && visible) {
                        const diff = now - createdTs;
                        if (timeVal === 'today') {
                            // 24h
                            if (diff > 24 * 60 * 60 * 1000) visible = false;
                        } else if (timeVal === 'last week') {
                            if (diff > 7 * 24 * 60 * 60 * 1000) visible = false;
                        } else if (timeVal === 'last month') {
                            if (diff > 30 * 24 * 60 * 60 * 1000) visible = false;
                        }
                    }

                    row.style.display = visible ? '' : 'none';
                });
            }

            // init (in case the selects had defaults)
            applyFilters();
        });
    </script>
</body>
</html>